# Generated by Ansible for {{ ansible_nodename  }}
################################################################################
# zplug 設定
################################################################################
# if [ ! -f ~/.zplug/init.zsh ]; then
#     echo "Installing zplug..."
#     unsetopt BG_NICE
#     curl -sL --proto-redir -all,https https://raw.githubusercontent.com/zplug/installer/master/installer.zsh| zsh
# fi
source ~/.zplug/init.zsh
zplug "zsh-users/zsh-autosuggestions"
zplug "zsh-users/zsh-history-substring-search"
zplug "willghatch/zsh-cdr"
zplug "zsh-users/zsh-completions"

zplug "plugins/git",   	    from:oh-my-zsh
zplug "plugins/autojump",   from:oh-my-zsh
zplug "modules/prompt",     from:prezto
zplug 'dracula/zsh', as:theme

zplug "zsh-users/zsh-syntax-highlighting", defer:2

################################################################################
# tmux
################################################################################
# ssh した時にウィンドウ名に接続先ホスト名を表示
if [[ -n $TMUX_PANE  ]]; then
    function ssh() {
        local name=$(tmux display -p '#{window_name}')
        tmux rename-window "ssh[${@:-1:1]}]" > /dev/null 2>&1
        command ssh "$@"
        tmux rename-window $name > /dev/null 2>&1
    }
fi


################################################################################
# zoxide
################################################################################
if (which zoxide >& /dev/null) then
   eval "$(zoxide init zsh)"
fi

################################################################################
# fzf
################################################################################
if [ ! -f ~/.fzf.zsh ]; then
    git clone https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install --all
fi
source ~/.fzf.zsh

export FZF_DEFAULT_COMMAND='ag --hidden --ignore .git -g ""'
export FZF_DEFAULT_OPTS='--height 40% --reverse --inline-info --bind "ctrl-k:kill-line"'
export FZF_TMUX=1

fd() {
  local dir
  dir=$(find ${1:-.} -path '*/\.*' -prune \
                  -o -type d -print 2> /dev/null | fzf +m) &&
  cd "$dir"
}

fshow() {
  git log --graph --color=always \
      --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" "$@" |
  fzf --ansi --no-sort --reverse --tiebreak=index --bind=ctrl-s:toggle-sort --preview "" \
      --bind "ctrl-m:execute:
                (grep -o '[a-f0-9]\{7\}' | head -1 |
                xargs -I % sh -c 'git show --color=always % | less -R') << 'FZF-EOF'
                {}
FZF-EOF"
}

fbr() {
  local branches branch
  branches=$(git branch --all | grep -v HEAD) &&
  branch=$(echo "$branches" |
           fzf-tmux -d $(( 2 + $(wc -l <<< "$branches") )) +m) &&
  git checkout $(echo "$branch" | sed "s/.* //" | sed "s#remotes/[^/]*/##")
}

j() {
    if [[ "$#" -ne 0 ]]; then
        cd $(autojump $@)
        return
    fi
    cd "$(autojump -s | sed '/_____/Q; s/^[0-9,.:]*\s*//' |  fzf-tmux --inline-info)"
}

fe() {
  local files
  IFS=$'\n' files=($(fzf-tmux --query="$1" --multi --select-1 --exit-0))
  [[ -n "$files" ]] && ${EDITOR:-vim} "${files[@]}"
}

# customize
fzf-history-widget-custom() {
    fc -R # Re-read the history file
    fzf-history-widget
}
zle     -N   fzf-history-widget-custom
bindkey '^R' fzf-history-widget-custom

################################################################################
# プロンプト
################################################################################
# POWERLEVEL9K_MODE='nerdfont-complete'
# POWERLEVEL9K_MODE='awesome-fontconfig'
# POWERLEVEL9K_MODE='awesome-patched'

zplug "bhilburn/powerlevel9k", use:powerlevel9k.zsh-theme

POWERLEVEL9K_SHOW_CHANGESET=true
POWERLEVEL9K_CHANGESET_HASH_LENGTH=6
POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(context dir dir_writable)
POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(vcs time)
POWERLEVEL9K_PROMPT_ON_NEWLINE=true
POWERLEVEL9K_MULTILINE_FIRST_PROMPT_PREFIX=""
POWERLEVEL9K_MULTILINE_LAST_PROMPT_PREFIX=" %% "
POWERLEVEL9K_SHORTEN_DIR_LENGTH=3
POWERLEVEL9K_DIR_ETC_FOREGROUND="195"
POWERLEVEL9K_DIR_HOME_FOREGROUND="195"
POWERLEVEL9K_DIR_DEFAULT_FOREGROUND="195"
POWERLEVEL9K_DIR_HOME_SUBFOLDER_FOREGROUND="195"
POWERLEVEL9K_SHORTEN_DIR_LENGTH=4
POWERLEVEL9K_SHORTEN_STRATEGY="truncate_to_first_and_last"
ZSH_THEME="powerlevel9k/powerlevel9k"

################################################################################
# zplug ロード
################################################################################
zplug check || zplug install
zplug load

################################################################################
# カラー
################################################################################
setopt prompt_subst

case ${SOLARIZED_THEME:-dark} in
    light) bkg=white;;
    *)     bkg=black;;
esac

case `whoami` in
     root) ucolor=red;;
     *)    ucolor=green;;
esac

ZSH_HIGHLIGHT_HIGHLIGHTERS=(main brackets)
ZSH_HIGHLIGHT_STYLES[alias]='none'
ZSH_HIGHLIGHT_STYLES[builtin]='none'
ZSH_HIGHLIGHT_STYLES[function]='none'
ZSH_HIGHLIGHT_STYLES[command]='none'
ZSH_HIGHLIGHT_STYLES[precommand]='none'
ZSH_HIGHLIGHT_STYLES[commandseparator]='none'
ZSH_HIGHLIGHT_STYLES[hashed-command]='none'
ZSH_HIGHLIGHT_STYLES[unknown-token]='fg=198'
ZSH_HIGHLIGHT_STYLES[single-quoted-argument]='fg=215'
ZSH_HIGHLIGHT_STYLES[double-quoted-argument]='fg=215'

################################################################################
# Keychain 等
################################################################################
stty stop undef
if [[ ($TERM == xterm*) || (-z $SSH_CLIENT && -z $EMACS) ]]; then
    if [[ -z $TMUX_PANE ]]; then
        # keychain
        if [[ -n ~/.ssh/*.id_rsa(#qN) ]]; then
            if (which =keychain >& /dev/null) then
                keychain ~/.ssh/*.id_rsa
                source ~/.keychain/`hostname`-sh >& /dev/null
            fi
        fi
        # emacs
        local EMACS_VERSION=${${${(f)"$(emacs --version)"}[1]}##GNU Emacs }
        if [[ $EMACS_VERSION > 22.9 ]] then
            =emacs --daemon >& /dev/null
        fi
        # tmux
        tmux a -d || tmux || echo 'Unable to start tmux.'
    elif if [[ -n ~/.ssh/*.id_rsa(#qN) ]]; then
        if (which =keychain >& /dev/null) then
            keychain ~/.ssh/*.id_rsa
            if [[ -e ~/.keychain/`hostname`-sh ]]; then
                source ~/.keychain/`hostname`-sh >& /dev/null
            fi
        fi
        # clear
    fi
fi

# Local Variables:
# mode: sh
# End:
###############################################################################
