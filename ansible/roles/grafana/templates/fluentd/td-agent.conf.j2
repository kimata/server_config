# Generated by Ansible for {{ ansible_hostname  }}

<system>
    log_level info
</system>    

################################################################################
# ソース
################################################################################
<source>
  @type forward
</source>

<source>
  @type http
  port 8888
</source>

<source>
  @type debug_agent
  bind 127.0.0.1
  port 24230
</source>

################################################################################
# 処理
################################################################################
<filter sensor.**>
  type typecast
  types temp:float,humi:float,lux:float,rain:float
</filter>

<match sensor>
  type rewrite_tag_filter
  <rule>
    key     hostname
    pattern ESP32
    tag     sensor.esp32
  </rule>
  <rule>
    key     hostname
    pattern rasp
    tag     sensor.raspberrypi
  </rule>
</match>

<filter {sensor.esp32,fplug.**}>
  type record_transformer
  enable_ruby
  renew_time_key self_time
  auto_typecast
  enable_ruby
  <record>
    self_time ${Time.now.to_i - record["self_time"].to_i }
  </record>
</filter>


# <filter sensor.**>
#   type record_transformer
#   enable_ruby
#   auto_typecast
#   enable_ruby
#   <record>
#     temp ${record["temp"].nil? ? nil : record["temp"].to_f}
#     humi ${record["humi"].nil? ? nil : record["humi"].to_f}
#     lux  ${record["humi"].nil? ? nil : record["humi"].to_f}
#   </record>
# </filter>

<match {sensor.**,fplug.**}>
  @type copy
  <store>
    @type file
    path /tmp/fluentd_debug.log
  </store>
  <store>
    @type influxdb
    host localhost
    dbname sensor
    tag_keys ["hostname"]
    time_precision s
    flush_interval 10
  </store>
</match>

<match *.**>
    @type file
    path /tmp/fluentd_all_debug.log
</match>

<filter test.**>
  type typecast
  types temp:float,humi:float,lux:float,rain:float
</filter>

<match test>
  type rewrite_tag_filter
  <rule>
    key     hostname
    pattern ESP32
    tag     sensor.esp32
  </rule>
  <rule>
    key     hostname
    pattern rasp
    tag     sensor.raspberrypi
  </rule>
</match>

<filter test.**>
  type record_transformer
  enable_ruby
  renew_time_key self_time
  <record>
       self_time ${Time.now.to_i - record["self_time"].to_i }
  </record>
</filter>

<match test.**>
  @type copy
  <store>
    @type file
      tag_keys ["hostname"]
      path /tmp/fluentd_test.log
  </store>
  # <store>
  #   @type influxdb
  #   host localhost
  #   dbname test
  #   tag_keys ["hostname"]
  #   time_precision s
  #   flush_interval 10
  # </store>
</match>


<match debug.**>
  @type stdout
</match>

# Local Variables:
# mode: conf
# End:
################################################################################
